/**
 * –£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏–π –¥–ª—è –∫–æ–º–∞–Ω–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AI –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–º—ã—Å–ª–∞ –∫–æ–º–∞–Ω–¥ –±–µ–∑ –∂–µ—Å—Ç–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
 */

/**
 * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –∫–æ–º–∞–Ω–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
 * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {string} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
 * @returns {Promise<Object>} –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏–π
 */
async function analyzeIntentWithAI(message, context = '') {
  try {
    console.log('üß† [INTENT] –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–º–µ—Ä–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', message);
    
    // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏–π
    const systemPrompt = `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ–º–∞–Ω–¥–æ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—Å–æ–∑–¥–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

–ê–ù–ê–õ–ò–ó–ò–†–£–ô:
- –ö–æ–º–∞–Ω–¥—ã —Å–æ–∑–¥–∞–Ω–∏—è: "—Å–æ–∑–¥–∞–π", "–Ω–∞—Ä–∏—Å—É–π", "—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π", "–¥–∏–∑–∞–π–Ω", "–ø—Ä–∏–Ω—Ç"
- –ö–æ–º–∞–Ω–¥—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: "—É–±–µ—Ä–∏", "—É–¥–∞–ª–∏", "–¥–æ–±–∞–≤—å", "–∏–∑–º–µ–Ω–∏", "–ø–æ–º–µ–Ω—è–π", "–±–µ–∑", "—Å–¥–µ–ª–∞–π"
- –û–±—ä–µ–∫—Ç—ã: "–º–µ—á", "—à–ª–µ–º", "–æ—Ä—É–∂–∏–µ", "—Ñ–æ–Ω", "—Ü–≤–µ—Ç", "–Ω–∞–¥–ø–∏—Å—å", "—Ç–µ–∫—Å—Ç"

–û–¢–í–ï–ß–ê–ô –¢–û–õ–¨–ö–û –í JSON –§–û–†–ú–ê–¢–ï:
{
  "isImageCommand": true/false,
  "action": "create/edit/null",
  "target": "–º–µ—á/—à–ª–µ–º/—Ñ–æ–Ω/—Ü–≤–µ—Ç/null",
  "operation": "—É–±—Ä–∞—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å/null",
  "confidence": 0.0-1.0,
  "enhancedPrompt": "—É–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞"
}`;

    const userPrompt = `–ö–æ–Ω—Ç–µ–∫—Å—Ç: ${context}
–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${message}"

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—Ç—å –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ.`;

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Claude –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏–π (–æ–Ω –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç)
    const g4fProvider = require('./g4f-provider');
    
    const response = await g4fProvider.getResponse(userPrompt, {
      systemPrompt: systemPrompt,
      provider: 'Claude', // Claude –æ—Ç–ª–∏—á–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏—è
      temperature: 0.1, // –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
      timeout: 10000
    });

    if (response.success && response.text) {
      console.log('üß† [INTENT] –û—Ç–≤–µ—Ç AI:', response.text);
      
      // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
      const jsonMatch = response.text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const intentData = JSON.parse(jsonMatch[0]);
        console.log('üß† [INTENT] –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ:', intentData);
        return intentData;
      }
    }

    // Fallback: –µ—Å–ª–∏ AI –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
    return simpleIntentAnalysis(message);

  } catch (error) {
    console.error('üß† [INTENT] –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏–π:', error);
    // Fallback –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑
    return simpleIntentAnalysis(message);
  }
}

/**
 * –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –∫–∞–∫ fallback
 * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns {Object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
 */
function simpleIntentAnalysis(message) {
  const msg = message.toLowerCase();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã —Å–æ–∑–¥–∞–Ω–∏—è
  const createPatterns = [
    /—Å–æ–∑–¥–∞–π.*–ø—Ä–∏–Ω—Ç/i, /–Ω–∞—Ä–∏—Å—É–π/i, /—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π.*–∫–∞—Ä—Ç–∏–Ω–∫/i,
    /–¥–∏–∑–∞–π–Ω.*—Ñ—É—Ç–±–æ–ª–∫/i, /–ø—Ä–∏–Ω—Ç.*—Ñ—É—Ç–±–æ–ª–∫/i, /—Å–æ–∑–¥–∞–π.*–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ/i,
    /–ª–æ–≥–æ—Ç–∏–ø/i, /—Ä–∏—Å—É–Ω–æ–∫/i, /–º–∞–∫–µ—Ç/i, /–∫–æ–Ω—Ü–µ–ø—Ç/i
  ];
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const editPatterns = [
    /—É–±–µ—Ä–∏.*–º–µ—á–∏/i, /—É–±–µ—Ä–∏.*–º–µ—á/i, /—É–±–µ—Ä–∏.*—à–ª–µ–º/i, /—É–±–µ—Ä–∏.*–Ω–∞–¥–ø–∏—Å—å/i,
    /—É–¥–∞–ª–∏.*–º–µ—á–∏/i, /—É–¥–∞–ª–∏.*–º–µ—á/i, /—É–¥–∞–ª–∏.*—à–ª–µ–º/i, /—É–¥–∞–ª–∏.*—Ç–µ–∫—Å—Ç/i,
    /–∏–∑–º–µ–Ω–∏.*—Ü–≤–µ—Ç/i, /–∏–∑–º–µ–Ω–∏.*—à–ª–µ–º/i, /–¥–æ–±–∞–≤—å.*–Ω–∞.*—Ñ–æ–Ω/i,
    /–¥–æ–±–∞–≤—å.*–≥—Ä–∏–±—ã/i, /–¥–æ–±–∞–≤—å.*—Ü–≤–µ—Ç—ã/i, /–±–µ–∑.*–º–µ—á–µ–π/i, /–±–µ–∑.*—à–ª–µ–º–∞/i
  ];
  
  const isCreate = createPatterns.some(pattern => pattern.test(message));
  const isEdit = editPatterns.some(pattern => pattern.test(message));
  
  if (isCreate) {
    return {
      isImageCommand: true,
      action: 'create',
      target: null,
      operation: '—Å–æ–∑–¥–∞—Ç—å',
      confidence: 0.8,
      enhancedPrompt: message
    };
  }
  
  if (isEdit) {
    let target = null;
    let operation = null;
    
    if (/–º–µ—á|–æ—Ä—É–∂–∏–µ|–∫–ª–∏–Ω–æ–∫|–∫–∞—Ç–∞–Ω–∞/i.test(msg)) target = '–º–µ—á';
    if (/—à–ª–µ–º|–∫–∞—Å–∫–∞|–≥–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä/i.test(msg)) target = '—à–ª–µ–º';
    if (/—Ñ–æ–Ω|–∑–∞–¥–Ω–∏–π –ø–ª–∞–Ω/i.test(msg)) target = '—Ñ–æ–Ω';
    if (/—Ü–≤–µ—Ç|–æ–∫—Ä–∞—Å/i.test(msg)) target = '—Ü–≤–µ—Ç';
    
    if (/—É–±–µ—Ä–∏|—É–¥–∞–ª–∏|–±–µ–∑/i.test(msg)) operation = '—É–±—Ä–∞—Ç—å';
    if (/–¥–æ–±–∞–≤—å|–ø–æ—Å—Ç–∞–≤—å/i.test(msg)) operation = '–¥–æ–±–∞–≤–∏—Ç—å';
    if (/–∏–∑–º–µ–Ω–∏|–ø–æ–º–µ–Ω—è–π/i.test(msg)) operation = '–∏–∑–º–µ–Ω–∏—Ç—å';
    
    return {
      isImageCommand: true,
      action: 'edit',
      target: target,
      operation: operation,
      confidence: 0.7,
      enhancedPrompt: `–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ—Ö–Ω–æ—Å–∞–º—É—Ä–∞—è: ${message}. –°–æ—Ö—Ä–∞–Ω–∏ –æ–±—â–∏–π —Å—Ç–∏–ª—å –∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é.`
    };
  }
  
  return {
    isImageCommand: false,
    action: null,
    target: null,
    operation: null,
    confidence: 0.0,
    enhancedPrompt: null
  };
}

/**
 * –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
 * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns {boolean} –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–º–∞–Ω–¥–æ–π –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
 */
function isLikelyImageCommand(message) {
  const imageKeywords = [
    '—Å–æ–∑–¥–∞–π', '–Ω–∞—Ä–∏—Å—É–π', '—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π', '–¥–∏–∑–∞–π–Ω', '–ø—Ä–∏–Ω—Ç', '–ª–æ–≥–æ—Ç–∏–ø',
    '—É–±–µ—Ä–∏', '—É–¥–∞–ª–∏', '–¥–æ–±–∞–≤—å', '–∏–∑–º–µ–Ω–∏', '–ø–æ–º–µ–Ω—è–π', '–∑–∞–º–µ–Ω–∏', '–±–µ–∑', '—Å–¥–µ–ª–∞–π',
    '–º–µ—á', '—à–ª–µ–º', '–æ—Ä—É–∂–∏–µ', '—Ñ–æ–Ω', '—Ü–≤–µ—Ç', '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', '–∫–∞—Ä—Ç–∏–Ω–∫', '–∂–µ–ª–µ–∑–∫–∞'
  ];
  
  const msg = message.toLowerCase();
  return imageKeywords.some(keyword => msg.includes(keyword));
}

module.exports = {
  analyzeIntentWithAI,
  simpleIntentAnalysis,
  isLikelyImageCommand
};