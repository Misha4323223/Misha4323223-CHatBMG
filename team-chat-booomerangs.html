<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOOOMERANGS Team Chat - –ö–æ–º–∞–Ω–¥–Ω—ã–π —á–∞—Ç</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, 
          rgba(243, 244, 246, 0.95) 0%,
          rgba(229, 231, 235, 0.95) 50%,
          rgba(209, 213, 219, 0.95) 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        backdrop-filter: blur(10px);
      }

      /* –°—Ç–∏–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
      .header {
        background: linear-gradient(135deg, 
          rgba(75, 85, 99, 0.95) 0%,
          rgba(107, 114, 128, 0.95) 50%,
          rgba(75, 85, 99, 0.95) 100%);
        color: white;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        backdrop-filter: blur(15px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.9rem;
        opacity: 0.9;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ffd700, #ffb300);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #8b4513;
        font-size: 0.8rem;
      }

      /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ */
      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
        padding: 0 20px;
      }

      /* –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π */
      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: calc(100vh - 200px);
      }

      /* –°—Ç–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
      .message {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        max-width: 85%;
      }

      .message.own {
        align-self: flex-end;
        flex-direction: row-reverse;
        background: linear-gradient(135deg, 
          rgba(99, 102, 241, 0.1) 0%,
          rgba(139, 92, 246, 0.1) 100%);
        border: 1px solid rgba(99, 102, 241, 0.2);
      }

      .message.other {
        align-self: flex-start;
        background: linear-gradient(135deg, 
          rgba(255, 255, 255, 0.8) 0%,
          rgba(243, 244, 246, 0.8) 100%);
        border: 1px solid rgba(209, 213, 219, 0.3);
      }

      .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ffd700, #ffb300);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #8b4513;
        font-size: 0.9rem;
        flex-shrink: 0;
      }

      .message-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .message-header {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        opacity: 0.7;
      }

      .message-username {
        font-weight: 600;
        color: #4f46e5;
      }

      .message-time {
        color: #6b7280;
      }

      .message-text {
        color: #374151;
        line-height: 1.5;
        font-size: 0.95rem;
      }

      /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
      .input-container {
        padding: 20px 0;
        background: linear-gradient(135deg, 
          rgba(255, 255, 255, 0.9) 0%,
          rgba(249, 250, 251, 0.9) 100%);
        backdrop-filter: blur(15px);
        border-top: 1px solid rgba(209, 213, 219, 0.3);
      }

      .input-form {
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }

      .message-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid rgba(209, 213, 219, 0.5);
        border-radius: 12px;
        font-size: 1rem;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        resize: none;
        min-height: 48px;
        max-height: 120px;
        font-family: inherit;
        line-height: 1.4;
      }

      .message-input:focus {
        outline: none;
        border-color: rgba(99, 102, 241, 0.5);
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .send-button {
        padding: 12px 20px;
        background: linear-gradient(135deg, 
          #ffd700 0%,
          #ffed4e 25%,
          #ffc107 50%,
          #ffb300 75%,
          #ff8f00 100%);
        color: #8b4513;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 1rem;
        box-shadow: 
          0 4px 12px rgba(255, 215, 0, 0.3),
          0 0 20px rgba(255, 215, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      .send-button:hover {
        transform: translateY(-2px);
        box-shadow: 
          0 8px 25px rgba(255, 215, 0, 0.4),
          0 0 30px rgba(255, 215, 0, 0.2);
        filter: brightness(1.1);
      }

      .send-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ */
      .typing-indicator {
        display: none;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        margin: 8px 0;
        background: rgba(107, 114, 128, 0.1);
        border-radius: 8px;
        font-size: 0.85rem;
        color: #6b7280;
        font-style: italic;
      }

      .typing-dots {
        display: flex;
        gap: 2px;
      }

      .typing-dot {
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: #6b7280;
        animation: typing 1.5s infinite;
      }

      .typing-dot:nth-child(2) { animation-delay: 0.2s; }
      .typing-dot:nth-child(3) { animation-delay: 0.4s; }

      @keyframes typing {
        0%, 60%, 100% { opacity: 0.3; }
        30% { opacity: 1; }
      }

      /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
      .nav-buttons {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .nav-button {
        padding: 8px 16px;
        background: linear-gradient(135deg, 
          rgba(107, 114, 128, 0.8) 0%,
          rgba(75, 85, 99, 0.8) 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .nav-button:hover {
        background: linear-gradient(135deg, 
          rgba(129, 140, 248, 0.9) 0%,
          rgba(99, 102, 241, 0.9) 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      }

      /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
      @media (max-width: 768px) {
        .header {
          padding: 12px 16px;
        }
        
        .header h1 {
          font-size: 1.3rem;
        }
        
        .chat-container {
          padding: 0 12px;
        }
        
        .message {
          max-width: 95%;
          padding: 10px 12px;
        }
        
        .nav-buttons {
          flex-direction: column;
          gap: 8px;
        }
        
        .nav-button {
          padding: 6px 12px;
          font-size: 0.8rem;
        }
      }

      /* –≠—Ñ—Ñ–µ–∫—Ç –∑–∞–≥—Ä—É–∑–∫–∏ */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        color: #6b7280;
        font-style: italic;
      }

      /* –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */
      .connection-status {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        opacity: 0.8;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10b981;
        animation: pulse 2s infinite;
      }

      .status-dot.disconnected {
        background: #ef4444;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü™É BOOOMERANGS Team Chat</h1>
        <div class="nav-buttons">
            <a href="/booomerangs-smart-chat.html" class="nav-button">ü§ñ AI Chat</a>
            <a href="/login.html" class="nav-button">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <div class="user-info">
                <div class="connection-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                </div>
                <div class="user-avatar" id="userAvatar">M</div>
                <span id="currentUser">–ú–∏—Ö–∞–∏–ª</span>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div class="messages-container" id="messagesContainer">
            <div class="loading" id="loadingIndicator">
                –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞...
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <span id="typingUser">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span> –ø–µ—á–∞—Ç–∞–µ—Ç
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <div class="input-container">
            <form class="input-form" id="messageForm">
                <textarea 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–µ BOOOMERANGS..."
                    rows="1"
                ></textarea>
                <button type="submit" class="send-button" id="sendButton">
                    ü™É –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </form>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = '–ú–∏—Ö–∞–∏–ª';
        let userId = 1;
        let isConnected = true;
        let typingTimeout;
        let lastMessageId = 0;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const messageForm = document.getElementById('messageForm');
        const sendButton = document.getElementById('sendButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const typingIndicator = document.getElementById('typingIndicator');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const userAvatar = document.getElementById('userAvatar');
        const currentUserSpan = document.getElementById('currentUser');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadChatHistory();
            setupEventListeners();
            startPolling();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/auth/user');
                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    userId = userData.id || 1;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    currentUserSpan.textContent = currentUser;
                    userAvatar.textContent = currentUser.charAt(0).toUpperCase();
                }
            } catch (error) {
                console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
        async function loadChatHistory() {
            try {
                const response = await fetch('/api/team-chat/messages');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.messages) {
                        displayMessages(data.messages);
                        if (data.messages.length > 0) {
                            lastMessageId = Math.max(...data.messages.map(m => m.id));
                        }
                    }
                } else {
                    showEmptyState();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
                showEmptyState();
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        function displayMessages(messages) {
            messagesContainer.innerHTML = '';
            messages.forEach(message => {
                addMessageToUI(message);
            });
            scrollToBottom();
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI
        function addMessageToUI(message) {
            const messageDiv = document.createElement('div');
            const isOwn = message.username === currentUser || message.userId === userId;
            
            messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${(message.username || 'U').charAt(0).toUpperCase()}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-username">${message.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</span>
                        <span class="message-time">${formatTime(message.timestamp || message.createdAt)}</span>
                    </div>
                    <div class="message-text">${escapeHtml(message.content || message.text)}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage(content) {
            if (!content.trim()) return;

            try {
                const response = await fetch('/api/team-chat/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: content.trim(),
                        username: currentUser,
                        userId: userId
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ polling
                        messageInput.value = '';
                        adjustTextareaHeight();
                    }
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
            }
        }

        // Polling –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function startPolling() {
            setInterval(async () => {
                try {
                    const response = await fetch(`/api/team-chat/messages?after=${lastMessageId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.messages && data.messages.length > 0) {
                            data.messages.forEach(message => {
                                addMessageToUI(message);
                                lastMessageId = Math.max(lastMessageId, message.id);
                            });
                            scrollToBottom();
                        }
                        updateConnectionStatus(true);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ polling:', error);
                    updateConnectionStatus(false);
                }
            }, 2000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
            messageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const content = messageInput.value.trim();
                if (content) {
                    sendButton.disabled = true;
                    await sendMessage(content);
                    sendButton.disabled = false;
                }
            });

            // –ê–≤—Ç–æ–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ textarea
            messageInput.addEventListener('input', () => {
                adjustTextareaHeight();
            });

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Ctrl+Enter
            messageInput.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    messageForm.dispatchEvent(new Event('submit'));
                }
            });
        }

        // –ê–≤—Ç–æ–∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        function showEmptyState() {
            messagesContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6b7280; font-style: italic;">
                    <div style="font-size: 3rem; margin-bottom: 16px;">ü™É</div>
                    <div>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥–Ω—ã–π —á–∞—Ç BOOOMERANGS!</div>
                    <div style="font-size: 0.9rem; margin-top: 8px;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–æ–π</div>
                </div>
            `;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                z-index: 1000;
                font-size: 0.9rem;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 3000);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function updateConnectionStatus(connected) {
            isConnected = connected;
            statusDot.className = `status-dot ${connected ? '' : 'disconnected'}`;
            statusText.textContent = connected ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–ù–µ—Ç —Å–≤—è–∑–∏';
        }
    </script>
</body>
</html>